# Generated by Django 4.2.23 on 2025-08-13 18:58

from django.db import migrations
from django.utils.text import slugify

def backfill(apps, schema_editor):
    Movie = apps.get_model('api', 'Movie')
    Rating = apps.get_model('api', 'Rating')

    for m in Movie.objects.all():
        if not m.slug:
            base = slugify(f"{m.title}-{m.year or ''}") or "movie"
            m.slug = f"{base}-{m.movieId}"

        vals = list(Rating.objects.filter(movie=m).values_list('rating', flat=True))
        if vals:
            m.rating_count = len(vals)
            m.avg_rating = round(sum(vals) / len(vals), 2)

        m.save()


class Migration(migrations.Migration):

    dependencies = [
        ('api', '0010_alter_movietag_unique_together_alter_movietag_id'),
    ]

    operations = [
        migrations.RunPython(backfill, reverse_code=migrations.RunPython.noop),
    ]
